var Ce=Object.defineProperty;var Ee=(r,e,s)=>e in r?Ce(r,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):r[e]=s;var B=(r,e,s)=>(Ee(r,typeof e!="symbol"?e+"":e,s),s);import{e as we}from"../chunks/index.8f2ca6db.js";import{s as ze,f,a as j,u as Ie,g as p,d as b,c as k,h as T,v as N,j as h,E as $,w as g,i as Y,F as G,H as ye,B as Te,o as Re,p as De,l as Oe,m as je,n as ke,A as Q}from"../chunks/scheduler.f95f0c95.js";import{S as Ne,i as Me,t as re,c as Fe,a as ae,g as $e,b as Se,d as ve,m as _e,e as be}from"../chunks/index.a7b2bf40.js";import{g as le}from"../chunks/navigation.9fa37e41.js";import{p as Ae}from"../chunks/stores.bcc05b25.js";import{R as Le,a as Pe}from"../chunks/RefineToolbox.bd88cd4f.js";const Ue=async({url:r,params:e})=>{const s=r.searchParams.get("session"),t=r.searchParams.get("source")||"direct-link";if(!s)throw we(400,{message:"No image session provided",details:"Please navigate to this page from the main application"});return{sessionId:s,source:t,timestamp:Date.now()}},ss=Object.freeze(Object.defineProperty({__proto__:null,load:Ue},Symbol.toStringTag,{value:"Module"})),He=new Map;class Ve{constructor(){B(this,"SESSION_PREFIX","img_session_");B(this,"CLEANUP_INTERVAL",1e3*60*60);B(this,"MAX_SESSION_AGE",1e3*60*60);B(this,"COMPRESSION_THRESHOLD",1024*100);B(this,"STORAGE_SIZE_LIMIT",1024*1024*2);B(this,"VERSION",1);this.scheduleCleanup()}get memoryStore(){return He}async createSession(e,s,t="/"){const i=this.generateSessionId(),a=this.generateImageId(),n=e.length+s.length,l=n>this.STORAGE_SIZE_LIMIT;console.log(`Image data size: ${n} bytes, Large image: ${l}`);const d={originalImage:e,processedImage:s,imageId:a,returnPath:t,timestamp:Date.now(),hasRefinedResult:!1,isLargeImage:l,originalImageSize:e.length,processedImageSize:s.length};try{if(l){console.log(`Using memory storage for large image session: ${i}`),this.memoryStore.set(i,d),console.log(`Memory store now has ${this.memoryStore.size} sessions`),console.log("Memory store keys:",Array.from(this.memoryStore.keys()));const o={sessionId:i,imageId:a,returnPath:t,timestamp:d.timestamp,isLargeImage:!0,originalImageSize:e.length,processedImageSize:s.length};return sessionStorage.setItem(`${this.SESSION_PREFIX}${i}`,JSON.stringify(o)),console.log(`Created large image session in memory: ${i}`),i}else{const o=await this.compressSessionData(d),c=`${this.SESSION_PREFIX}${i}`,m=JSON.stringify(o);return console.log(`Using sessionStorage for regular image: ${i}`),console.log(`Storage value size: ${m.length} bytes`),sessionStorage.setItem(c,m),console.log(`Created image session: ${i}`),i}}catch(o){throw console.error("Failed to create image session:",o),new Error(`Failed to store image session data: ${o.message}`)}}getSession(e){try{if(console.log(`Looking for session: ${e}`),console.log(`Memory store has ${this.memoryStore.size} sessions`),console.log("Memory store keys:",Array.from(this.memoryStore.keys())),console.log("Memory store has this session:",this.memoryStore.has(e)),this.memoryStore.has(e)){const n=this.memoryStore.get(e);return this.isSessionExpired(n)?(console.warn(`Memory session expired: ${e}`),this.memoryStore.delete(e),this.removeSession(e),null):(console.log(`Retrieved large image session from memory: ${e}`),n)}const s=sessionStorage.getItem(`${this.SESSION_PREFIX}${e}`);if(!s)return console.warn(`Session not found: ${e}`),null;const t=JSON.parse(s);if(t.isLargeImage&&!this.memoryStore.has(e))return console.warn(`Large image session data not found in memory: ${e}`),this.removeSession(e),null;const i=t,a=this.decompressSessionData(i);return this.isSessionExpired(a)?(console.warn(`Session expired: ${e}`),this.removeSession(e),null):(console.log(`Retrieved regular image session from sessionStorage: ${e}`),a)}catch(s){return console.error(`Failed to get session ${e}:`,s),null}}updateSession(e,s){try{const t=this.getSession(e);if(!t)return console.warn(`Cannot update non-existent session: ${e}`),!1;const i={...t,...s,lastModified:Date.now()},a=this.compressSessionData(i);return sessionStorage.setItem(`${this.SESSION_PREFIX}${e}`,JSON.stringify(a)),console.log(`Updated session: ${e}`),!0}catch(t){return console.error(`Failed to update session ${e}:`,t),!1}}removeSession(e){try{return this.memoryStore.has(e)&&(this.memoryStore.delete(e),console.log(`Removed session from memory: ${e}`)),sessionStorage.removeItem(`${this.SESSION_PREFIX}${e}`),console.log(`Removed session: ${e}`),!0}catch(s){return console.error(`Failed to remove session ${e}:`,s),!1}}getAllSessionIds(){const e=[];try{for(let s=0;s<sessionStorage.length;s++){const t=sessionStorage.key(s);t&&t.startsWith(this.SESSION_PREFIX)&&e.push(t.substring(this.SESSION_PREFIX.length))}}catch(s){console.error("Failed to get session IDs:",s)}return e}cleanupExpiredSessions(){return this.cleanup()}cleanup(){const e=this.getAllSessionIds();let s=0;for(const t of e){const i=this.getSession(t);(!i||this.isSessionExpired(i))&&(this.removeSession(t),s++)}return console.log(`Cleaned up ${s} expired sessions`),s}getStorageStats(){const e=this.getAllSessionIds();let s=0,t=null,i=null;for(const a of e)try{const n=`${this.SESSION_PREFIX}${a}`,l=sessionStorage.getItem(n);if(l){s+=l.length*2;const d=this.getSession(a);d&&((t===null||d.timestamp<t)&&(t=d.timestamp),(i===null||d.timestamp>i)&&(i=d.timestamp))}}catch(n){console.error(`Error processing session ${a}:`,n)}return{sessionCount:e.length,totalSize:s,oldestSession:t,newestSession:i}}generateSessionId(){return`${Date.now()}_${Math.random().toString(36).substr(2,9)}`}generateImageId(){return`img_${Date.now()}_${Math.random().toString(36).substr(2,6)}`}isSessionExpired(e){return Date.now()-e.timestamp>this.MAX_SESSION_AGE}async compressSessionData(e){const s=JSON.stringify(e);return console.log(`Session data size: ${s.length} bytes`),{data:s,compressed:!1,version:this.VERSION}}decompressSessionData(e){if(e.compressed)try{const s=this.decompressString(e.data);return JSON.parse(s)}catch(s){throw console.error("Decompression failed:",s),new Error("Failed to decompress session data")}return JSON.parse(e.data)}async compressString(e){try{const s=encodeURIComponent(e),t=this.lzCompress(s);return btoa(t)}catch(s){return console.warn("Compression failed, storing uncompressed:",s),btoa(e)}}decompressString(e){try{const s=atob(e),t=this.lzDecompress(s);return decodeURIComponent(t)}catch(s){try{return atob(e)}catch{throw console.error("Decompression failed:",s),new Error("Failed to decompress session data")}}}lzCompress(e){const s={},t=e.split(""),i=[];let a=256,n=t[0];for(let l=1;l<t.length;l++){const d=t[l],o=n+d;s[o]!==void 0?n=o:(i.push(n.length>1?s[n]:n.charCodeAt(0)),s[o]=a++,n=d)}return i.push(n.length>1?s[n]:n.charCodeAt(0)),String.fromCharCode(...i)}lzDecompress(e){const s={},t=e.split("").map(l=>l.charCodeAt(0));let i=256,a=String.fromCharCode(t[0]);const n=[a];for(let l=1;l<t.length;l++){const d=t[l];let o;s[d]!==void 0?o=s[d]:d===i?o=a+a[0]:o=String.fromCharCode(d),n.push(o),s[i++]=a+o[0],a=o}return n.join("")}scheduleCleanup(){setTimeout(()=>this.cleanup(),1e3),setInterval(()=>this.cleanup(),this.CLEANUP_INTERVAL),typeof window<"u"&&window.addEventListener("beforeunload",()=>this.cleanup())}}const ce=new Ve;function Be(r){let e,s,t,i,a,n,l,d={originalImage:r[0],processedImage:r[1],currentTool:r[5],brushSize:r[6],showComparison:r[7],showOriginal:r[8]};return t=new Le({props:d}),r[27](t),t.$on("initialized",r[25]),t.$on("error",r[24]),n=new Pe({props:{currentTool:r[5],brushSize:r[6],canUndo:r[9],canRedo:r[10],isCollapsed:r[11]}}),n.$on("toolChanged",r[14]),n.$on("brushSizeChanged",r[15]),n.$on("collapseToggled",r[16]),n.$on("undo",r[17]),n.$on("redo",r[18]),n.$on("reset",r[19]),{c(){e=f("div"),s=f("div"),Se(t.$$.fragment),i=j(),a=f("aside"),Se(n.$$.fragment),this.h()},l(o){e=p(o,"DIV",{class:!0});var c=T(e);s=p(c,"DIV",{class:!0});var m=T(s);ve(t.$$.fragment,m),m.forEach(b),i=k(c),a=p(c,"ASIDE",{class:!0});var v=T(a);ve(n.$$.fragment,v),v.forEach(b),c.forEach(b),this.h()},h(){h(s,"class","canvas-area svelte-1dz9ngj"),h(a,"class","toolbox-area svelte-1dz9ngj"),$(a,"collapsed",r[11]),h(e,"class","workspace svelte-1dz9ngj")},m(o,c){Y(o,e,c),g(e,s),_e(t,s,null),g(e,i),g(e,a),_e(n,a,null),l=!0},p(o,c){const m={};c[0]&1&&(m.originalImage=o[0]),c[0]&2&&(m.processedImage=o[1]),c[0]&32&&(m.currentTool=o[5]),c[0]&64&&(m.brushSize=o[6]),c[0]&128&&(m.showComparison=o[7]),c[0]&256&&(m.showOriginal=o[8]),t.$set(m);const v={};c[0]&32&&(v.currentTool=o[5]),c[0]&64&&(v.brushSize=o[6]),c[0]&512&&(v.canUndo=o[9]),c[0]&1024&&(v.canRedo=o[10]),c[0]&2048&&(v.isCollapsed=o[11]),n.$set(v),(!l||c[0]&2048)&&$(a,"collapsed",o[11])},i(o){l||(ae(t.$$.fragment,o),ae(n.$$.fragment,o),l=!0)},o(o){re(t.$$.fragment,o),re(n.$$.fragment,o),l=!1},d(o){o&&b(e),r[27](null),be(t),be(n)}}}function Xe(r){let e,s,t="‚ö†Ô∏è",i,a,n="Something went wrong",l,d,o,c,m,v="Return to Main Page",C,w;return{c(){e=f("div"),s=f("div"),s.textContent=t,i=j(),a=f("h2"),a.textContent=n,l=j(),d=f("p"),o=Oe(r[3]),c=j(),m=f("button"),m.textContent=v,this.h()},l(R){e=p(R,"DIV",{class:!0});var _=T(e);s=p(_,"DIV",{class:!0,"data-svelte-h":!0}),N(s)!=="svelte-tecbtq"&&(s.textContent=t),i=k(_),a=p(_,"H2",{class:!0,"data-svelte-h":!0}),N(a)!=="svelte-1ak0vu3"&&(a.textContent=n),l=k(_),d=p(_,"P",{class:!0});var E=T(d);o=je(E,r[3]),E.forEach(b),c=k(_),m=p(_,"BUTTON",{class:!0,"data-svelte-h":!0}),N(m)!=="svelte-13rfp1f"&&(m.textContent=v),_.forEach(b),this.h()},h(){h(s,"class","error-icon svelte-1dz9ngj"),h(a,"class","error-title svelte-1dz9ngj"),h(d,"class","error-message svelte-1dz9ngj"),h(m,"class","error-retry-btn svelte-1dz9ngj"),h(e,"class","error-container svelte-1dz9ngj")},m(R,_){Y(R,e,_),g(e,s),g(e,i),g(e,a),g(e,l),g(e,d),g(d,o),g(e,c),g(e,m),C||(w=G(m,"click",r[26]),C=!0)},p(R,_){_[0]&8&&ke(o,R[3])},i:Q,o:Q,d(R){R&&b(e),C=!1,w()}}}function Je(r){let e,s='<div class="loading-spinner svelte-1dz9ngj"></div> <p class="loading-text svelte-1dz9ngj">Loading your image...</p>';return{c(){e=f("div"),e.innerHTML=s,this.h()},l(t){e=p(t,"DIV",{class:!0,"data-svelte-h":!0}),N(e)!=="svelte-17pob47"&&(e.innerHTML=s),this.h()},h(){h(e,"class","loading-container svelte-1dz9ngj")},m(t,i){Y(t,e,i)},p:Q,i:Q,o:Q,d(t){t&&b(e)}}}function Ge(r){let e,s,t,i,a,n,l,d='<span class="breadcrumb-icon svelte-1dz9ngj">‚Üê</span> <span class="breadcrumb-text svelte-1dz9ngj">Back to Main</span>',o,c,m="Refine Image",v,C,w,R='<span class="view-icon svelte-1dz9ngj">‚öñÔ∏è</span> <span class="view-text svelte-1dz9ngj">Compare</span>',_,E,q='<span class="view-icon svelte-1dz9ngj">üëÅÔ∏è</span> <span class="view-text svelte-1dz9ngj">Original</span>',X,A,z,I,W,H,M,D,x='<span class="action-icon svelte-1dz9ngj">‚úï</span> <span class="action-text">Cancel</span>',Z,O,L,ee="üíæ",K,P,se="Save & Return",u,U,ie,de;const ue=[Je,Xe,Be],V=[];function ge(S,y){return S[2]?0:S[3]?1:2}return z=ge(r),I=V[z]=ue[z](r),{c(){e=f("meta"),s=j(),t=f("div"),i=f("header"),a=f("div"),n=f("nav"),l=f("button"),l.innerHTML=d,o=j(),c=f("h1"),c.textContent=m,v=j(),C=f("div"),w=f("button"),w.innerHTML=R,_=j(),E=f("button"),E.innerHTML=q,X=j(),A=f("main"),I.c(),W=j(),H=f("footer"),M=f("div"),D=f("button"),D.innerHTML=x,Z=j(),O=f("button"),L=f("span"),L.textContent=ee,K=j(),P=f("span"),P.textContent=se,this.h()},l(S){const y=Ie("svelte-qb2fw3",document.head);e=p(y,"META",{name:!0,content:!0}),y.forEach(b),s=k(S),t=p(S,"DIV",{class:!0});var F=T(t);i=p(F,"HEADER",{class:!0});var me=T(i);a=p(me,"DIV",{class:!0});var J=T(a);n=p(J,"NAV",{class:!0});var he=T(n);l=p(he,"BUTTON",{class:!0,"data-svelte-h":!0}),N(l)!=="svelte-24s13s"&&(l.innerHTML=d),he.forEach(b),o=k(J),c=p(J,"H1",{class:!0,"data-svelte-h":!0}),N(c)!=="svelte-n69v3x"&&(c.textContent=m),v=k(J),C=p(J,"DIV",{class:!0});var te=T(C);w=p(te,"BUTTON",{class:!0,title:!0,"data-svelte-h":!0}),N(w)!=="svelte-sh0wz3"&&(w.innerHTML=R),_=k(te),E=p(te,"BUTTON",{class:!0,title:!0,"data-svelte-h":!0}),N(E)!=="svelte-v5sg2j"&&(E.innerHTML=q),te.forEach(b),J.forEach(b),me.forEach(b),X=k(F),A=p(F,"MAIN",{class:!0});var fe=T(A);I.l(fe),fe.forEach(b),W=k(F),H=p(F,"FOOTER",{class:!0});var pe=T(H);M=p(pe,"DIV",{class:!0});var oe=T(M);D=p(oe,"BUTTON",{class:!0,"data-svelte-h":!0}),N(D)!=="svelte-1brmr41"&&(D.innerHTML=x),Z=k(oe),O=p(oe,"BUTTON",{class:!0});var ne=T(O);L=p(ne,"SPAN",{class:!0,"data-svelte-h":!0}),N(L)!=="svelte-kkg5zm"&&(L.textContent=ee),K=k(ne),P=p(ne,"SPAN",{class:!0,"data-svelte-h":!0}),N(P)!=="svelte-boggg6"&&(P.textContent=se),ne.forEach(b),oe.forEach(b),pe.forEach(b),F.forEach(b),this.h()},h(){document.title="Refine Image - CharacterCut",h(e,"name","description"),h(e,"content","Refine and perfect your character image with advanced editing tools"),h(l,"class","breadcrumb-btn svelte-1dz9ngj"),h(n,"class","breadcrumb"),h(c,"class","page-title svelte-1dz9ngj"),h(w,"class","view-btn svelte-1dz9ngj"),h(w,"title","Compare original vs processed"),$(w,"active",r[7]),h(E,"class","view-btn svelte-1dz9ngj"),h(E,"title","Toggle original preview"),$(E,"active",r[8]),h(C,"class","view-controls svelte-1dz9ngj"),h(a,"class","header-content svelte-1dz9ngj"),h(i,"class","refine-header svelte-1dz9ngj"),h(A,"class","refine-main svelte-1dz9ngj"),h(D,"class","action-btn secondary svelte-1dz9ngj"),h(L,"class","action-icon svelte-1dz9ngj"),h(P,"class","action-text"),h(O,"class","action-btn primary svelte-1dz9ngj"),O.disabled=u=r[2]||!!r[3],h(M,"class","footer-content svelte-1dz9ngj"),h(H,"class","refine-footer svelte-1dz9ngj"),h(t,"class","refine-page svelte-1dz9ngj"),$(t,"mobile",r[12]),$(t,"desktop",r[13])},m(S,y){g(document.head,e),Y(S,s,y),Y(S,t,y),g(t,i),g(i,a),g(a,n),g(n,l),g(a,o),g(a,c),g(a,v),g(a,C),g(C,w),g(C,_),g(C,E),g(t,X),g(t,A),V[z].m(A,null),g(t,W),g(t,H),g(H,M),g(M,D),g(M,Z),g(M,O),g(O,L),g(O,K),g(O,P),U=!0,ie||(de=[G(l,"click",r[23]),G(w,"click",r[20]),G(E,"click",r[21]),G(D,"click",r[23]),G(O,"click",r[22])],ie=!0)},p(S,y){(!U||y[0]&128)&&$(w,"active",S[7]),(!U||y[0]&256)&&$(E,"active",S[8]);let F=z;z=ge(S),z===F?V[z].p(S,y):($e(),re(V[F],1,1,()=>{V[F]=null}),Fe(),I=V[z],I?I.p(S,y):(I=V[z]=ue[z](S),I.c()),ae(I,1),I.m(A,null)),(!U||y[0]&12&&u!==(u=S[2]||!!S[3]))&&(O.disabled=u),(!U||y[0]&4096)&&$(t,"mobile",S[12]),(!U||y[0]&8192)&&$(t,"desktop",S[13])},i(S){U||(ae(I),U=!0)},o(S){re(I),U=!1},d(S){S&&(b(s),b(t)),b(e),V[z].d(),ie=!1,ye(de)}}}function qe(r,e,s){let t;Te(r,Ae,u=>s(29,t=u));let i=null,a=null,n=null,l=!0,d=null,o,c="restore",m=20,v=!1,C=!1,w=!1,R=!1,_=!1,E=!1,q=!1;Re(async()=>{try{if(X(),window.addEventListener("resize",X),n=t.url.searchParams.get("session"),!n)throw new Error("No session ID provided");const u=await ce.getSession(n);if(!u)throw new Error("Session not found");if(s(0,i=u.originalImage),s(1,a=u.processedImage),!i||!a)throw new Error("Invalid session data");s(2,l=!1),console.log("‚úÖ Refine page initialized with session:",n)}catch(u){console.error("‚ùå Failed to initialize refine page:",u),s(3,d=u instanceof Error?u.message:"Unknown error"),s(2,l=!1)}});function X(){s(12,E=window.innerWidth<768),s(13,q=window.innerWidth>=1024),E&&!_&&s(11,_=!0)}function A(u){s(5,c=u.detail.tool),console.log("üîß Tool changed to:",c)}function z(u){s(6,m=u.detail.size),console.log("üñåÔ∏è Brush size changed to:",m)}function I(u){s(11,_=u.detail.collapsed)}function W(){if(o){const u=o.undo();console.log("‚Ü∂ Undo:",u?"success":"failed"),D()}}function H(){if(o){const u=o.redo();console.log("‚Ü∑ Redo:",u?"success":"failed"),D()}}function M(){o&&(o.reset(),console.log("üîÑ Canvas reset"),D())}function D(){s(9,w=!0),s(10,R=!1)}function x(){s(7,v=!v),s(8,C=!1),console.log("üîÑ Comparison mode:",v)}function Z(){s(8,C=!C),s(7,v=!1),console.log("üîÑ Original preview:",C)}async function O(){if(!(!o||!n))try{const u=o.exportCanvas();if(!u)throw new Error("Failed to export canvas");await ce.updateSession(n,{processedImage:u,lastModified:new Date}),console.log("üíæ Image saved successfully"),le("/")}catch(u){console.error("‚ùå Failed to save image:",u),s(3,d="Failed to save image")}}function L(){n&&ce.clearSession(n),le("/")}function ee(u){s(3,d=u.detail.message),console.error("‚ùå Canvas error:",d)}function K(){D(),console.log("‚úÖ Canvas initialized successfully")}const P=()=>le("/");function se(u){De[u?"unshift":"push"](()=>{o=u,s(4,o)})}return[i,a,l,d,o,c,m,v,C,w,R,_,E,q,A,z,I,W,H,M,x,Z,O,L,ee,K,P,se]}class ts extends Ne{constructor(e){super(),Me(this,e,qe,Ge,ze,{},null,[-1,-1])}}export{ts as component,ss as universal};
